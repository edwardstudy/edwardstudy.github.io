<!doctype html><html lang=en dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>MongoBD+Solr全文搜索的历程 | Edwardesire</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=/js/eureka.min.e30461307d4134a93cbbd7301a29631abc285b8d3df327389368cd910c20926df5759064caf0f8ba686f65edcbdff5ee.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'"><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<link rel=stylesheet href=/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload="this.media='all',this.onload=null"><script defer type=text/javascript src=/js/fontawesome.min.7b735802cbde01152678cc4a867f0b4bb0597876e29adfcaf1e5b5e99d39d7af87f348fdfd91c7eaf9ed7dc1eece7c61.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload="this.media='all',this.onload=null" crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32_hub39b788047e733a7d94c242c3bed8659_782_32x32_fill_box_center_3.png><link rel=apple-touch-icon sizes=180x180 href=/images/favicon-32x32_hub39b788047e733a7d94c242c3bed8659_782_180x180_fill_box_center_3.png><meta name=description content="当存储到数据库中的数据涉及到文本，针对文本的搜索需求就应运而生。MongoDB也支持文本的搜索，不过很可惜的是，MongoDB的$text不支持中文分"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"/posts/"},{"@type":"ListItem","position":2,"name":"MongoBD+Solr全文搜索的历程","item":"/posts/full-text-search-of-mongodb-with-solr/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/full-text-search-of-mongodb-with-solr/"},"headline":"MongoBD\u002bSolr全文搜索的历程 | Edwardesire","datePublished":"2015-10-26T15:04:26+00:00","dateModified":"2015-10-26T15:04:26+00:00","wordCount":3822,"publisher":{"@type":"Person","name":"C. Wang","logo":{"@type":"ImageObject","url":"/images/favicon-32x32.png"}},"description":"当存储到数据库中的数据涉及到文本，针对文本的搜索需求就应运而生。MongoDB也支持文本的搜索，不过很可惜的是，MongoDB的$text不支持中文分"}</script><meta property="og:title" content="MongoBD+Solr全文搜索的历程 | Edwardesire"><meta property="og:type" content="article"><meta property="og:image" content="/images/favicon-32x32.png"><meta property="og:url" content="/posts/full-text-search-of-mongodb-with-solr/"><meta property="og:description" content="当存储到数据库中的数据涉及到文本，针对文本的搜索需求就应运而生。MongoDB也支持文本的搜索，不过很可惜的是，MongoDB的$text不支持中文分"><meta property="og:locale" content="en"><meta property="og:site_name" content="Edwardesire"><meta property="article:published_time" content="2015-10-26T15:04:26+00:00"><meta property="article:modified_time" content="2015-10-26T15:04:26+00:00"><meta property="article:section" content="posts"><meta property="article:tag" content="MongoDB"><meta property="article:tag" content="Solr"><meta property="og:see_also" content="/posts/mongodb-update-operators-apply/"><meta property="og:see_also" content="/posts/mongodb-query-and-projection-operators-apply/"><meta property="og:see_also" content="/posts/mongodb-fetch-sql-server-change-data-capture/"><meta property="og:see_also" content="/posts/pagination-with-mongoose/"><meta property="og:see_also" content="/posts/test-persistent-image-file-in-mongodb/"><meta property="og:see_also" content="/posts/the-mongodb-tempter/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Edwardesire</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">Posts</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="lg:col-start-2 bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>MongoBD+Solr全文搜索的历程</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2015-10-26</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>8 min read</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=/categories/mongodb/ class=hover:text-eureka>MongoDB</a>
<span>,</span>
<a href=/categories/solr/ class=hover:text-eureka>Solr</a></div></div><p>当存储到数据库中的数据涉及到文本，针对文本的搜索需求就应运而生。MongoDB也支持文本的搜索，不过很可惜的是，MongoDB的$text不支持中文分词功能，在搜索中文文本时只会字符的匹配，这在使用上非常不方便。</p><p>最近做的一个项目中就有这个需求。师哥推荐solr+mmseq4j的组合实现中文搜索。最初的设想只是针对邮件系统的标题以及正文两个字段的提供搜索。在2次迭代后，增加了其他一些关键字段的索引，以提供搜索页面的二次过滤。本文首先简介Solr工具，在实机安装了Solr，接着实现针对中文文本字段的索引，以及一步步的增加索引字段以实现项目需求。技术上解决的问题主要有：Solr获取MongoDB增量数据，针对数组对象建立索引。</p><hr><p>####1. Solr安装</p><p>Solr是Apache开发的开源搜索服务器，基于HTTP和Apache的Lucene。也就是说，索引的生成、搜索都是通过向Solr服务器发出HTTP请求。</p><blockquote><p>在 Solr 和 Lucene 中，使用一个或多个 Document 来构建索引。Document 包括一个或多个 Field。Field 包括名称、内容以及告诉 Solr 如何处理内容的元数据。例如，Field 可以包含字符串、数字、布尔值或者日期，也可以包含您想添加的任何类型。Field 可以使用大量的选项来描述，这些选项告诉 Solr 在索引和搜索期间如何处理内容。</p></blockquote><p>在接下来的安装使用中继续说明不同Field的参数。这里在罗嗦一些基本概念。Solr的分析主要涉及到3个组件：分析器(Analyzers)、分词器(Tokenizers)和标记过滤器(Token Filters)。分析器用来预处理文本。分词器将文本分割成不同的token，这些token传递给标记过滤器来增删改token。这里还有提一下字符过滤器，它用来预处理字符。一般地，一个分析器由零个或多个字符过滤器，一个分词器以及零个到多个标记过滤器。这些都是概念都是为了衡量文本之间的相似性以便搜索文本内容。</p><blockquote><p>例如，Solr 的 WhitespaceTokenizer 根据空白断词，而它的 StopFilter 从搜索结果中删除公共词。其他类型的分析包括词干提取、同义词扩展和大小写折叠。如果应用程序要求以某种特殊方式进行分析，则 Solr 所拥有的一个或多个断词工具和筛选器可以满足您的要求。</p></blockquote><p>正如前面所说,Solr通过HTTP请求来进行索引操作，而Solr的索引操作分为如下4种：</p><ul><li>add/update：添加文档或更新文档。直到提交后才能搜索到这些添加和更新。</li><li>commit：明确更新，使得上次提交以来所做的所有更改都可以搜索到。</li><li>optimize：重构文件以优化搜索性能。</li><li>delete：删除文档，可以通过 id 或查询来指定。</li></ul><p>这里的文档就是需要搜索的对象文件。Solr的搜索命令只接受GET和POST方法，收到请求的Solr通过SolrRequestHandler来处理。</p><p><img src=http://edwardsblog.qiniudn.com/image/2/e4/63bfe96d2da8c5de988acd5bc7728.png alt=图来自IBM文档></p><p>上面简单介绍了Solr的特性，其内部技术核心还是比较复杂的，接下来就介绍安装配置Solr的方法。</p><p>####2. 安装配置Solr</p><p>安装的Solr版本为4.10.3，在阿里云的Centos系统上。整个安装过程比较顺利，但在开始选择版本上做过多的犹豫。解压后进入solr-4.10.3/exmaple/multicore/目录，我们使用multicore的场景，这是solr.home就是multicore了。接着在<a href=https://github.com/chenlb/mmseg4j-solr>mmseg4j-solr@github</a>上下载mmes4j，版本选择匹配的2.2.0(里头3个文件分别为：mmseg4j-analysis-1.9.1.jar、mmseg4j-core-1.10.0.jar、mmseg4j-solr-2.2.0.jar)。将3个jar放入../multicore/lib中就安装完成了。</p><p>接下来配置Solr的模式(Schema)，模式可以由类型、字段和其他声明组成。这里我们首先需要定义类型，然后依据类型定义字段。用编辑器打开./multicore/core0/config/schema.xml。可以看到Solr已经预定义了如下类型：</p><pre><code>&lt;fieldtype name=&quot;string&quot;  class=&quot;solr.StrField&quot; sortMissingLast=&quot;true&quot; omitNorms=&quot;true&quot;/&gt;
&lt;fieldType name=&quot;int&quot; class=&quot;solr.TrieIntField&quot; precisionStep=&quot;0&quot; positionIncrementGap=&quot;0&quot;/&gt;
&lt;fieldType name=&quot;long&quot; class=&quot;solr.TrieLongField&quot; precisionStep=&quot;0&quot; positionIncrementGap=&quot;0&quot;/&gt;
&lt;fieldType name=&quot;date&quot; class=&quot;solr.TrieDateField&quot; sortMissingLast=&quot;true&quot; omitNorms=&quot;true&quot;/&gt;
</code></pre><p>mmseg4j的中文类型的配置也挺简单，这里我们选择中文分词的&rsquo;complex&rsquo;模式，在schema.xml文件中配置一个fieldType节点，如下：</p><pre><code>&lt;!-- mmseg4j --&gt;
&lt;fieldType name=&quot;text_zh&quot; class=&quot;solr.TextField&quot; positionIncrementGap=&quot;100&quot;&gt;
   &lt;analyzer&gt;
       &lt;tokenizer class=&quot;com.chenlb.mmseg4j.solr.MMSegTokenizerFactory&quot; mode=&quot;complex&quot; /&gt;
   &lt;/analyzer&gt;
&lt;/fieldType&gt;
</code></pre><p>然后就可以在field节点中引用该filedType了，假设你有个字段叫my_content需要支持中文分词，只需要定义示例filed节点如下：</p><pre><code>&lt;field name=&quot;my_content&quot; type=&quot;text_zh&quot; indexed=&quot;true&quot; stored=&quot;false&quot; multiValued=&quot;true&quot;/&gt;
</code></pre><p>接下来我们依据项目的具体业务设置需要搜索的字段，其中MongoDB的主键_id字段就是原始的id字段，我们需要修改其字段并为_id，并且将uniqueKey也修改为&lt;uniqueKey>_id&lt;/uniqueKey>。记得我们需要搜索的中文字段为邮件的中文以及标题，所以这里把两个字段的字段设置为&rsquo;text_zh&rsquo;类型。</p><pre><code>&lt;field name=&quot;mail.text&quot; type=&quot;text_zh&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;false&quot; /&gt;
&lt;field name=&quot;mail.subject&quot; type=&quot;text_zh&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;false&quot; /&gt;
</code></pre><p>最后一步就是运行Solr了。回到刚才的example目录，运行目录java -Dsolr.solr.home=multicore -jar start.jar</p><p>这是打开浏览器的8983端口，就能看到Solr的后台。慢着，我们的数据还没有，需要到MongoDB上获取。这里使用mongodb-labs的<a href=https://github.com/mongodb-labs/mongo-connector>mongo-connector</a>，按照官方说明安装即可。</p><p>####3. mongo-connector的安装与使用</p><p>mongo-connector的工作原理就是获取MongoDB副本集的oplog（操作日志），日志信息记录了文档的CRUD中的时间、命名空间以及修改的文档数据等。具体可以看<a href=https://github.com/mongodb-labs/mongo-connector/wiki/Oplog%20Progress%20File>Oplog文件@官方WIKI</a>、<a href=https://github.com/mongodb-labs/mongo-connector/wiki/System%20Overview>System Overview@官方WIKI</a>。嗯，所以使用之前需要将副本集配置好。</p><p>这里就设置一个简单的主从副本，端口分别为27001、27002。配置先开启2个mongod程序，再进入主节点配置副本集。</p><pre><code># mongod --port 27001 --oplogSize 100 --dbpath /opt/db/rs1 --logpath /opt/db/log/rs1.log --replSet rs/127.0.0.1:27002 --journal
# mongod --port 27002 --oplogSize 100 --dbpath /opt/db/rs2 --logpath /opt/db/log/rs2.log --replSet rs/127.0.0.1:27001 --journal
# mongo --port 27001
&gt; config={_id:'rs',members:[{_id: 0, host: '127.0.0.1:27001'}, {_id: 1, host: '127.0.0.1.:27002'}]}
&gt; rs.initiate(config)
&gt; rs.status()
</code></pre><p>这样就将MongoDB启动了，接下来安装好mongo-connector，并运行程序（可全局运行）。</p><pre><code># git clone https://github.com/10gen-labs/mongo-connector.git
# cd mongo-connector
# python setup.py install
//运行命令
# mongo-connector -m localhost:27001 -t http://localhost:8983/solr/core0 -n gossip.mails -d solr_doc_manager --auto-commit-interval=1
</code></pre><p>这样就行了吗？这样会报错的，还必须在Solr的Schema中存储metadata的定义以及开启LukeRequestHandler开启。在schema.xml中添加如下片段。</p><field name=_ts type=long indexed=true stored=true required multivalued=false><field name=ns type=string indexed=true stored=true required multivalued=false><p>以及同目录下的solrconfig.xml</p><pre><code>&lt;requestHandler name=&quot;/admin/luke&quot; class=&quot;org.apache.solr.handler.admin.LukeRequestHandler&quot; /&gt;
</code></pre><p>通过netstat命令可以指定mongo-connector的端口以及监听端口。</p><p><img src=http://edwardsblog.qiniudn.com/image/f/67/7ccc7f9a0f5b9c0e49331834fa8e5.png alt=命令output></p><p>这样mongo-connector就能监听MongoDB的数据变化并传递给Solr。整个搜索的基础架构如下。</p><p><img src=http://edwardsblog.qiniudn.com/image/7/28/a4f80731365bdfb12c35966e01294.jpg alt=搜索架构></p><p>####4. checkout：搜索</p><p>这一部分通过solr的web后台，进行数据搜索的测试。首先在浏览器输入：http://serverIp:8983/solr/#/core0。 注意我们Solr采取的是多核模式。</p><p>core0的首页面如下，展示的是总文档数以及系统参数。</p><p><img src=http://edwardsblog.qiniudn.com/image/a/c9/2206aafd6f767eede2b9b51ec0a11.png alt=首页面></p><p>字段分析器的测试如下。</p><p><img src=http://edwardsblog.qiniudn.com/image/3/86/45e0c60eda864367cb50087be37a6.png alt=分词></p><p>最后query页为搜索的功能测试，可以看到结果还是蛮理想的。</p><p><img src=http://edwardsblog.qiniudn.com/image/6/9b/682de1ab211e1152450c42c719480.png alt></p><p>####5. 数组的索引</p><p>第二次迭代主要是满足搜索的需求，比如检查邮件是否有附件，在通过imap获取邮件时，检查附件数组，并存储到邮件的一个字段记录是否有附件hasAttach。这个好处理，直接添加schema中的字段即可。</p><pre><code>&lt;field name=&quot;hasAttach&quot; type=&quot;int&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;false&quot; /&gt;
&lt;field name=&quot;filterStatus&quot; type=&quot;int&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;false&quot; /&gt;
&lt;field name=&quot;recyleStatus&quot; type=&quot;int&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;false&quot; /&gt;
&lt;field name=&quot;mail.date&quot; type=&quot;date&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;false&quot; /&gt;
</code></pre><p>比较麻烦的是最后一个需求需要去索引数组中的元素。这里就要引入一个schema配置中的动态字段(dynamicField)、和复制字段(copyfield)。动态字段可以通过<em>来匹配多个字段，这又要提到在mongo-connector会将数组扁平化。比如一个数组rules，形成rules.0.ruleId以及rules.1.ruleId这样的字段，我们可通过动态字段rules</em>来匹配这些数组里的元素。但是我们无法在Solr中通过rules*来搜索字段，这时就要通过复制字段来搜索了。复制字段的两个属性source、dest如同一个管道一样将source数据映射到dest上，当搜索dest时，就会到source上去建立索引。那么在我们的第三次修改中将数组字段这样处理，具体的配置信息如下。</p><pre><code>&lt;!-- mailFrom are from.address and from.name field --&gt;
&lt;dynamicField name=&quot;mail.from*&quot; type=&quot;text_zh&quot; indexed=&quot;true&quot; stored=&quot;true&quot; /&gt;
&lt;field name=&quot;mailFrom&quot; type=&quot;text_zh&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; /&gt;
&lt;copyField source=&quot;mail.from*&quot; dest=&quot;mailFrom&quot; /&gt;
&lt;field name=&quot;commonStatus&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;false&quot; /&gt;
&lt;field name=&quot;score&quot; type=&quot;int&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;false&quot; /&gt;
&lt;!-- operationStr are operations.action and operations.description --&gt;
&lt;dynamicField name=&quot;operations*&quot; type=&quot;text_zh&quot; indexed=&quot;true&quot; stored=&quot;true&quot; /&gt;
&lt;field name=&quot;operationStr&quot; type=&quot;text_zh&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; /&gt;
&lt;copyField source=&quot;operations*&quot; dest=&quot;operationStr&quot; /&gt;
&lt;!-- categoryStr are category id str --&gt;
&lt;dynamicField name=&quot;category*&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; /&gt;
&lt;field name=&quot;catId&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; /&gt;
&lt;copyField source=&quot;category*&quot; dest=&quot;catId&quot; /&gt;
&lt;!-- ruleId is rules.ruleId string --&gt;
&lt;dynamicField name=&quot;rules*&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
&lt;field name=&quot;ruleId&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; /&gt;
&lt;copyField source=&quot;rules*&quot; dest=&quot;ruleId&quot; /&gt;
</code></pre><p>其实这种方式是十分丑陋的，copyField会将source字段中的所有元素转换为dest的同类型数据，比如我在rules数组下有一个int类型的变量来标记状态，但搜索时的结果就转换为string了。其次，资源的消耗也增加来。但对于目标搜索还是能够满足的，暂且就这样妥协的实现。</p><p>####5. Node as Solr Client</p><p>最后再简单描述一下node端调用Solr的HTTP接口，这里使用的是solr-client库。</p><pre><code>var qStr = '(mail.text: (' + fixedSearchKeyword + ') OR mail.subject: (' + fixedSearchKeyword + '))';
var query = client.createQuery()
  .q(qStr)
  .sort(sort)
  .start(start)
  .rows(rows)
  .fl('_id');
client.search(query, function(err, obj){
  if(err){
    console.log(err);
  }else{
    //其他处理
  }
});
</code></pre><p>最后做出的搜索应用如下，还不错。</p><p><img src=http://edwardsblog.qiniudn.com/image/c/7d/074fe81b4eebe1f352d1db6da77b4.png alt=搜索></p><hr><p>参考</p><ol><li><p><a href=http://www.ibm.com/developerworks/cn/java/j-solr1/#resources>《使用 Apache Solr 实现更加灵巧的搜索，第 1 部分: 基本特性和 Solr 模式》@IBM文档</a></p></li><li><p><a href=http://wiki.apache.org/solr/AnalyzersTokenizersTokenFilters#Char_Filters>Analyzers, Tokenizers, and Token Filters@SolrWiki</a></p></li><li><p><a href=http://www.cnblogs.com/sysuys/p/3403670.html>Solr与MongoDB集成@cnblogs</a></p></li><li><p><a href=http://blog.csdn.net/we_izheng/article/details/45900945>《论mongo-connector如何将MongoDB中的json数组和嵌套对象更新至Solr引擎》@csdn</a></p></li></ol></article><div class=my-4><a href=/tags/mongodb/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#MongoDB</a>
<a href=/tags/solr/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#Solr</a></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div><span class="text-primary-text block font-bold">Previous</span>
<a href=/posts/reading-paper-knowledge-generation-model-for-visual-analytics/ class=block>Paper Reader:Knowledge Generation Model for Visual Analytics</a></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">Next</span>
<a href=/posts/controller-of-async-function/ class=block>使用Async进行流程控制</a></div></div><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//edwardesire.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div class="lg:col-start-2 bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>See Also</h3><a href=/posts/mongodb-update-operators-apply/ class=no-underline>MongoDB更新操作符的实践</a><br><a href=/posts/mongodb-query-and-projection-operators-apply/ class=no-underline>MongoDB查询以及投影操作符的实践</a><br><a href=/posts/mongodb-fetch-sql-server-change-data-capture/ class=no-underline>MongoDB/SQL Server增量同步方案</a><br><a href=/posts/pagination-with-mongoose/ class=no-underline>Web应用分页功能的简单实现</a><br><a href=/posts/test-persistent-image-file-in-mongodb/ class=no-underline>MongoDB图片存储测试</a><br><a href=/posts/the-mongodb-tempter/ class=no-underline>MongoDB理论浅入浅出</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2021 <a href=https://www.edwardesire.com/>Edward Desire</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>