<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width"><title>成功在BAE上部署ghost 5.0 | Edwardesire</title><meta name=generator content="Hugo Eureka 0.8.3"><link rel=stylesheet href=/css/eureka.min.css><script defer src=/js/eureka.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity="sha256-Zmpaaj+GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE=" crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32_hub39b788047e733a7d94c242c3bed8659_782_32x32_fill_box_center_3.png><link rel=apple-touch-icon sizes=180x180 href=/images/favicon-32x32_hub39b788047e733a7d94c242c3bed8659_782_180x180_fill_box_center_3.png><meta name=description content="这周摸索着网站的建设，终于在今天成功上线！这里要谢谢ghost中文网和群里的网友，他的博客在这opengiser。他们的帮助太重要了。现在把过程记录下"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"/posts/"},{"@type":"ListItem","position":2,"name":"成功在BAE上部署ghost 5.0","item":"/posts/cheng-gong-zai-baeshang-bu-shu-ghost-5-0/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/cheng-gong-zai-baeshang-bu-shu-ghost-5-0/"},"headline":"成功在BAE上部署ghost 5.0 | Edwardesire","datePublished":"2014-09-06T15:39:25+00:00","dateModified":"2014-09-06T15:39:25+00:00","wordCount":1351,"publisher":{"@type":"Person","name":"C. Wang","logo":{"@type":"ImageObject","url":"/images/favicon-32x32.png"}},"description":"这周摸索着网站的建设，终于在今天成功上线！这里要谢谢ghost中文网和群里的网友，他的博客在这opengiser。他们的帮助太重要了。现在把过程记录下"}</script><meta property="og:title" content="成功在BAE上部署ghost 5.0 | Edwardesire"><meta property="og:type" content="article"><meta property="og:image" content="/images/favicon-32x32.png"><meta property="og:url" content="/posts/cheng-gong-zai-baeshang-bu-shu-ghost-5-0/"><meta property="og:description" content="这周摸索着网站的建设，终于在今天成功上线！这里要谢谢ghost中文网和群里的网友，他的博客在这opengiser。他们的帮助太重要了。现在把过程记录下"><meta property="og:locale" content="en"><meta property="og:site_name" content="Edwardesire"><meta property="article:published_time" content="2014-09-06T15:39:25+00:00"><meta property="article:modified_time" content="2014-09-06T15:39:25+00:00"><meta property="article:section" content="posts"><meta property="article:tag" content="Beginner"><meta property="article:tag" content="BAE"><meta property="article:tag" content="Nodejs"><body class="flex flex-col min-h-screen"><header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm"><div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="mr-6 text-primary-text text-xl font-bold">Edwardesire</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Posts</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="flex-grow pt-16"><div class=pl-scrollbar><div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto"><div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12"><div class="col-span-2 lg:col-start-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8"><h1 class="font-bold text-3xl text-primary-text">成功在BAE上部署ghost 5.0</h1><div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text"><div class="mr-6 my-2"><i class="fas fa-calendar mr-1"></i>
<span>2014-09-06</span></div><div class="mr-6 my-2"><i class="fas fa-clock mr-1"></i>
<span>3 min read</span></div><div class="mr-6 my-2"><i class="fas fa-folder mr-1"></i>
<a href=/categories/beginner/ class=hover:text-eureka>Beginner</a>
<span>,</span>
<a href=/categories/bae/ class=hover:text-eureka>BAE</a>
<span>,</span>
<a href=/categories/nodejs/ class=hover:text-eureka>Nodejs</a></div></div><div class=content><p>这周摸索着网站的建设，终于在今天成功上线！这里要谢谢<a href=http://www.ghostchina.com/>ghost中文网</a>和群里的网友，他的博客在这<a href=http://www.opengiser.com>opengiser</a>。他们的帮助太重要了。现在把过程记录下来，共同学习。</p><hr><ol><li>下载安装包
总共需要下载2个东西。</li></ol><ul><li><a href=http://dl.ghostchina.com/Ghost-0.5.0.zip>ghost 5.0</a></li><li>BAE上的<a href=http://bcs.duapp.com/baev3demo/nodejs-web/mysql.tgz>mysql</a>依赖包</li></ul><ol start=2><li><p>新建BAE工程
在百度开发云平台的管理控制台下一次点击：开发者服务管理->创建工程->创建->应用引擎-添加部署-创建。这样nodejs的环境就建好了。这里一起把数据库也建立起来。这里我使用的是mysql，点击应用引擎中的扩展服务即可，添加新服务当然使用免费版的咯。</p></li><li><p>配置
接下来就是在本地把源码配置好咯。将工程clone下来后，用ghost源码覆盖掉。在本地运行命令npm install，后将下载好的mysql覆盖掉node_modules下原有的。然后打开根目录的config.example.js将database段修改为如下：</p><pre><code>  production: {
      database: {
          client: 'mysql',
          connection: {
              host: 'sqld.duapp.com',
              port: 4050,
              user: '#####', //你的ak
              password: '#####', //你的sk
              database: '#####',//数据库名
              charset: 'utf8'
          },
          debug: false
      },
      server: {
          host: '127.0.0.1',
          port: '18080'
      }       
 }
</code></pre><p>最后再修改根目录的config.example.js。修改启动命令，将"start": &ldquo;node index"改为"start&rdquo;: &ldquo;node index.js&rdquo;。并去掉依赖dependencies、optionalDependencies、devDependencies这三项。</p></li><li><p>修改5.0中与BAE不兼容的部分
按照q友悟道所说需要注释掉core/server/index.js中305行的ghostStartMessages()。原因是这个方法的内部与BAE不兼容。</p></li><li><p>图像存储问题
在package.json中的dependencies添加七牛的依赖包，在config.example.js中production和添加：</p><pre><code> qiniu: {
     bucketname: '#####', //七牛云的目录名
     ACCESS_KEY: '#####', //七牛云的ak
     SECRET_KEY: '#####', //七牛云的sk
     root: '/image/',
     prefix: 'http://' //七牛的空间域名
 }
</code></pre></li></ol><p>最后在core/server/storage做两个操作
+ 覆盖index.js文件</p><pre><code>        var errors = require('../errors'),
        storage;

        var qiniuConfig  = require('../config/').qiniu;

        function get_storage() {
            // TODO: this is where the check for storage apps should go
            // Local file system is the default
            var storageChoice = qiniuConfig? 'qiniu':'localfilesystem';
            if (storage) {
                return storage;
            }
            try {
                // TODO: determine if storage has all the necessary methods
                storage = require('./' + storageChoice);
            } catch (e) {
                errors.logError(e);
            }
            return storage;
        }
        module.exports.get_storage = get_storage;
+ 并添加一个qiniu.js文件
    
        // # Local File System Image Storage module
        // The (default) module for storing images, using the local file system

        var _       = require('lodash'),
            express = require('express'),
            fs      = require('fs-extra'),
            nodefn  = require('when/node/function'),
            path    = require('path'),
            when    = require('when'),
            config = require('../config'),
            errors  = require('../errors'),
            baseStore   = require('./base'),
            crypto = require('crypto'),
            qiniu        = require('qiniu'),
            qiniuConfig  = config.qiniu,
            qiniuStore;
            qiniu.conf.ACCESS_KEY = qiniuConfig.ACCESS_KEY;
            qiniu.conf.SECRET_KEY = qiniuConfig.SECRET_KEY;
            qiniu.conf.USER_AGENT = 'Ghost 0.4.2';
            var putPolicy = new qiniu.rs.PutPolicy(qiniuConfig.bucketname),
            uptoken = putPolicy.token();
            qiniuStore = _.extend(baseStore, {
            // ### Save
            // Saves the image to storage (the file system)
            // - image is the express image object
            // - returns a promise which ultimately returns the full url to the uploaded image
            'save': function (image) {
                var saved = when.defer(),
                md5sum = crypto.createHash('md5'),
                ext = path.extname(image.name),
                targetDirRoot = qiniuConfig.root,
                targetFilename,
                key,
                extra = new qiniu.io.PutExtra();
                var savedpath = path.join(config.paths.imagesPath, image.name);
                nodefn.call(fs.copy, image.path, savedpath).then(function(){
                    return nodefn.call(fs.readFile, savedpath);
                    }).then(function(data) {
                    md5 = md5sum.update(data).digest('hex');
                    targetFilename = path.join(targetDirRoot, md5.replace(/^(\w{1})(\w{2})(\w+)$/, '$1/$2/$3')) + ext;
                    targetFilename = targetFilename.replace(/\\/g, '/');
                    key = targetFilename.replace(/^\//, '');
                    return nodefn.call(qiniu.io.put, uptoken, key, data, extra);
                    }).then(function () {
                    return nodefn.call(fs.unlink, savedpath).then(function(){
                    return nodefn.call(fs.unlink, image.path);
                    }).otherwise(errors.logError);
                    }).then(function () {
                    // prefix + targetFilename
                    var fullUrl = qiniuConfig.prefix + targetFilename;
                    return saved.resolve(fullUrl);
                    }).otherwise(function (e) {
                    errors.logError(e);
                    return saved.reject(e);
                    });
                    return saved.promise;
              },
              'exists': function (filename) {
                  // fs.exists does not play nicely with nodefn because the callback doesn't have an error argument
                  var done = when.defer();
                  fs.exists(filename, function (exists) {
                      done.resolve(exists);
                  });
                  return done.promise;
              },
              // middleware for serving the files
              'serve': function () {
                  var ONE_HOUR_MS = 60 * 60 * 1000,
                      ONE_YEAR_MS = 365 * 24 * ONE_HOUR_MS;
                  // For some reason send divides the max age number by 1000
                  return express['static'](config.paths.imagesPath, {maxAge: ONE_YEAR_MS});
              }
          });

          module.exports = qiniuStore;

最后注释掉fonts.googleapis相关的字体加载，就可以上传代码、发布咯。
</code></pre><ol start=6><li>Next
个人觉得需要<strong>文章分类</strong>、<strong>归档archive</strong>和<strong>评论区</strong>，接下来就是搞定他们了。</li></ol><hr><p>！参考学习</p><ol><li><a href=http://www.opengiser.com/baeghost0-5/>开源GIS人上的ghost5.0部署文章</a></li><li><a href=http://www.ghostchina.com/deploy-ghost-in-bae-with-qiniu-cloud/>中文网教程</a></li><li><a href="http://developer.baidu.com/wiki/index.php?title=docs/cplat/bae/start">BAE新手入门</a></li></ol></div><div class=my-4><a href=/tags/beginner/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#Beginner</a>
<a href=/tags/bae/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#BAE</a>
<a href=/tags/nodejs/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#Nodejs</a></div><div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t"><div><span class="block font-bold">Previous</span>
<a href=/posts/nodejsxue-xi-shi-ge-zi-jia-de-twentybo-ke-kuang-jia/ class=block>nodejs学习：师哥自家的twenty博客框架</a></div><div class="md:text-right mt-4 md:mt-0"></div></div><div id=disqus_thread></div><script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//edwardesire.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.initHighlightingOnLoad()})</script></div></div></main><footer class=pl-scrollbar><div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2021 <a href=https://www.edwardesire.com/>Edward Desire</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>