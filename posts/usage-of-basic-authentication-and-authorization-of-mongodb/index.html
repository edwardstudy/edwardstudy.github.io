<!doctype html><html lang=en><meta charset=utf-8>
<meta name=viewport content="width=device-width">
<title>部署有身份验证的mongoDB | Edwardesire</title>
<meta name=generator content="Hugo Eureka 0.8.3">
<link rel=stylesheet href=/css/eureka.min.css>
<script defer src=/js/eureka.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'">
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity="sha256-Zmpaaj+GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE=" crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32_hub39b788047e733a7d94c242c3bed8659_782_32x32_fill_box_center_3.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/favicon-32x32_hub39b788047e733a7d94c242c3bed8659_782_180x180_fill_box_center_3.png>
<meta name=description content="mongoDB默认情况下是不需要身份认证的，但是处于生产环境安全的考虑，还是不能省去这一步的。本文将在这篇文章所述环境下部署带身份认证的mongoDB">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"/posts/"},{"@type":"ListItem","position":2,"name":"部署有身份验证的mongoDB","item":"/posts/usage-of-basic-authentication-and-authorization-of-mongodb/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/usage-of-basic-authentication-and-authorization-of-mongodb/"},"headline":"部署有身份验证的mongoDB | Edwardesire","datePublished":"2016-01-13T12:35:11+00:00","dateModified":"2016-01-13T12:35:11+00:00","wordCount":1939,"publisher":{"@type":"Person","name":"C. Wang","logo":{"@type":"ImageObject","url":"/images/favicon-32x32.png"}},"description":"mongoDB默认情况下是不需要身份认证的，但是处于生产环境安全的考虑，还是不能省去这一步的。本文将在这篇文章所述环境下部署带身份认证的mongoDB"}</script><meta property="og:title" content="部署有身份验证的mongoDB | Edwardesire">
<meta property="og:type" content="article">
<meta property="og:image" content="/images/favicon-32x32.png">
<meta property="og:url" content="/posts/usage-of-basic-authentication-and-authorization-of-mongodb/">
<meta property="og:description" content="mongoDB默认情况下是不需要身份认证的，但是处于生产环境安全的考虑，还是不能省去这一步的。本文将在这篇文章所述环境下部署带身份认证的mongoDB">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="Edwardesire">
<meta property="article:published_time" content="2016-01-13T12:35:11+00:00">
<meta property="article:modified_time" content="2016-01-13T12:35:11+00:00">
<meta property="article:section" content="posts">
<meta property="article:tag" content="MongoDB">
<meta property="og:see_also" content="/posts/code-to-meanjs/">
<meta property="og:see_also" content="/posts/full-text-search-of-mongodb-with-solr/">
<meta property="og:see_also" content="/posts/mongodb-update-operators-apply/">
<meta property="og:see_also" content="/posts/mongodb-query-and-projection-operators-apply/">
<meta property="og:see_also" content="/posts/mongodb-fetch-sql-server-change-data-capture/">
<meta property="og:see_also" content="/posts/pagination-with-mongoose/">
<body class="flex flex-col min-h-screen">
<header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
<div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
<a href=/ class="mr-6 text-primary-text text-xl font-bold">Edwardesire</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i>
</button>
<div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
<div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
<a href=/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item mr-4">Posts</a>
</div>
<div class=flex>
<div class="relative pt-4 md:pt-0">
<div class="cursor-pointer hover:text-eureka" id=lightDarkMode>
<i class="fas fa-adjust"></i>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open>
</div>
<div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions>
<span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span>
</div>
</div>
</div>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile>
</div>
</nav>
<script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script>
</div>
</header>
<main class="flex-grow pt-16">
<div class=pl-scrollbar>
<div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">
<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
<div class="col-span-2 lg:col-start-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
<h1 class="font-bold text-3xl text-primary-text">部署有身份验证的mongoDB</h1>
<div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
<div class="mr-6 my-2">
<i class="fas fa-calendar mr-1"></i>
<span>2016-01-13</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-clock mr-1"></i>
<span>4 min read</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-folder mr-1"></i>
<a href=/categories/mongodb/ class=hover:text-eureka>MongoDB</a>
</div>
</div>
<div class=content>
<p>mongoDB默认情况下是不需要身份认证的，但是处于生产环境安全的考虑，还是不能省去这一步的。本文将在<a href=/full-text-search-of-mongodb-with-solr>这篇文章</a>所述环境下部署带身份认证的mongoDB双副本集系统，具体内容包括了：</p>
<ul>
<li>配置用户和身份验证</li>
<li>配置内部验证到副本集</li>
<li>mongo-connector的验证方法</li>
</ul>
<hr>
<p>####1. 配置用户和身份认证</p>
<p>Web开发中，确保系统的安全也是后端开发任务之一。而确保mongoDB安全的最好方法就是在一个可信环境中运行实例，并且确保只有可信机器能过连接到服务器。在当前开发环境下，我们还需要远程连接数据库，所以不太适合选择绑定ip等方式来限制网络访问。但我们可以通过验证和授权的方式来提供安全可靠的数据库使用。monogDB提供的验证机制有很多种，我们使用的2.6版本采用MONGODB-CR机制，该机制通过用户名、密码和验证数据库来识别用户。而授权方面，mongoDB采用的是基于角色的访问控制（Role-Based Access Control, RBAC）。一个角色被授予针对数据库、集合、集群相应的权限，使得该角色能够针对资源进行操作。需要注意的是，除了在admin数据库，设置权限的用户角色只能作用于该用户所在的数据库。这些都是验证的依据原理，下面才是描述如何配置身份验证。</p>
<p>我们首先配置用户信息，然后再运行开启访问控制功能的mongod实例。mongoDB提高db.createUser()和db.updateUser()等<a href=https://docs.mongodb.org/manual/reference/method/js-user-management/>方法</a>来管理用户。顾名思义，db.createUser()提供创建数据库用户的功能，其第一个参数为用户对象，第二个参数为write Concern（指定写操作的确认方式）。我们需要从第一个参数定义user（用户名）、pwd（密码）、roles（角色）字段，并可以从中定义customData（自定义数据）字段。用户角色分为mongoDB内建角色和用户定义角色。内建角色又分为数据库用户角色和数据库管理角色，可以通过官网看到<a href=https://docs.mongodb.org/manual/core/security-built-in-roles/>详细信息</a>。</p>
<p>针对当前应用的环境，我们需要readWrite角色来读取数据集合，userAdmin角色来管理用户信息，clusterAdmin角色来管理分片、副本集群，dbAdmin角色来管理数据库。我们首先在无访问控制的情况下运行mongoDB来创建用户。在shell中输入如下命令（注意密码的设置）即可创建不同角色的用户，其中clusterAdmin还需指定针对config、local数据库的权限。这里之所以使用了AnyDatabase是处于方便操作全体数据库，在生产环境应该严格限制作用的数据库。</p>
<pre><code>use admin
db.createUser({ user: &quot;gossip&quot;, pwd: &quot;yourpassword&quot;, roles: [ &quot;readWriteAnyDatabase&quot; ]})
db.createUser({ user: &quot;dbAdmin&quot;, pwd: &quot;yourpassword&quot;, roles: [ &quot;dbAdminAnyDatabase&quot; ]})
db.createUser({ user: &quot;clusterAdmin&quot;, pwd: &quot;yourpassword&quot;, roles: [ &quot;clusterAdmin&quot;, { role: &quot;read&quot;, db: &quot;config&quot; }, { role: &quot;read&quot;, db: &quot;local&quot;} ]})
db.createUser({ user: &quot;superuser&quot;, pwd: &quot;yourpassword&quot;, roles: [ &quot;userAdminAnyDatabase&quot; ]})
</code></pre>
<p>建立好这3个用户后，可以通过show users来检查用户设置的正确性。最后通过重启mongoDB来应用访问控制，输入命令 <code>mongod admin --auth</code> 来限定需要验证才能成功连接数据库。</p>
<p>而验证连接数据库的目录参数如下， <code>mongo --port 27001 admin -u username -p</code> 。其表示连接admin数据库来验证username用户，接下来再输正确的密码即进入mongo shell。</p>
<p>####2. 配置内部验证到副本集</p>
<p>当在多节点环境（副本、分片）下启用身份验证时，mongoDB强制副本成员必要提供节点间验证的凭证才能相互通信。我们采用keyfile（使用SCRAM-SHA-1的验证机制）来进行内部验证。文档中采用的方法是生产一个较长的随机数来充当密码，不同节点直接需要相互验证这个密码文件。这里使用官网的方法，使用openssl命令的方法来生产随机数，并以文件形式保存。并将生成的文件提供给各个节点即可。具体命令如下：</p>
<pre><code># open rand -base64 741 &gt; /opt/mongo-keyfile` 
# chmod 600 mongo-keyfile
# mongod --keyfile /opt/mongo-keyfile
</code></pre>
<p>如果我们不进行内部验证会出现什么情况呢？当我们直接采用-auth启动两个副本时，mongoDB副本会一直处于recovering的状态，无法正常工作。</p>
<p>####3. mongo-connector的验证方法</p>
<p>mongo-connector工具可以实时从oplog中获取数据库的变动并通过pipiline的方式传递给其他系统，比如solr搜索引擎之类的系统。mongo-connector支持mongoDB所有的验证机制，并提供多种验证方式。简单的可以通过自身的参数来进行验证，但这种方法下，密码参数是可见的，使用ps命令就可以看到。在生产环境推荐使用其他方式，比如通过密码文件的方式。命令直接验证的参数为 <code>--admin-username &lt;administrator username> --password &lt;administrator password></code> 。</p>
<p>当然，在实际使用中我们针对针对不同的需求，添加mongo-connector使用的用户角色的修改。具体如下图：</p>
<p><img src=http://edwardsblog.qiniudn.com/image/9/5e/d892def4d53760611da75425fea61.png alt></p>
<p>在我们的系统中直接将mongo-connector可能需要的权限全部提供，整个系统当前的用户角色信息如下图：</p>
<p><img src=http://edwardsblog.qiniudn.com/image/f/8a/9d68dd707c66ddda00e9709a1ce8a.png alt></p>
<hr>
<p>###参考：</p>
<ol>
<li>
<p><a href=http://tgrall.github.io/blog/2015/02/04/introduction-to-mongodb-security/>mongoDB安全认证</a></p>
</li>
<li>
<p><a href=http://www.askmaclean.com/archives/deploy-replica-set-and-configure-authentication-and-authorization.html>配置副本集的身份验证</a></p>
</li>
<li>
<p><a href=https://github.com/mongodb-labs/mongo-connector/wiki/Usage-with-Authentication>mongo-connector</a></p>
</li>
<li>
<p><a href=https://docs.mongodb.org/manual/security/>官方3.*文档</a></p>
</li>
<li>
<p>书籍：《mongoDB权威指南》。</p>
</li>
</ol>
</div>
<div class=my-4>
<a href=/tags/mongodb/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 mr-2 hover:text-eureka">#MongoDB</a>
</div>
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
<div>
<span class="block font-bold">Previous</span>
<a href=/posts/mongdb-aggregation-example/ class=block>MongoDB Aggregation实践</a>
</div>
<div class="md:text-right mt-4 md:mt-0">
<span class="block font-bold">Next</span>
<a href=/posts/code-to-meanjs/ class=block>从MongoDB入门到编写数据库相关API</a>
</div>
</div>
<div id=disqus_thread></div>
<script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//edwardesire.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<div class="col-span-2 lg:col-start-2 lg:col-span-6 bg-secondary-bg rounded p-6">
<h2 class="text-lg font-semibold mb-4">See Also</h2>
<div class=content>
<a href=/posts/code-to-meanjs/>从MongoDB入门到编写数据库相关API</a>
<br>
<a href=/posts/full-text-search-of-mongodb-with-solr/>MongoBD+Solr全文搜索的历程</a>
<br>
<a href=/posts/mongodb-update-operators-apply/>MongoDB更新操作符的实践</a>
<br>
<a href=/posts/mongodb-query-and-projection-operators-apply/>MongoDB查询以及投影操作符的实践</a>
<br>
<a href=/posts/mongodb-fetch-sql-server-change-data-capture/>MongoDB/SQL Server增量同步方案</a>
<br>
<a href=/posts/pagination-with-mongoose/>Web应用分页功能的简单实现</a>
<br>
</div>
</div>
</div>
<script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script>
</div>
</div>
</main>
<footer class=pl-scrollbar>
<div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
<p class="text-sm text-tertiary-text">&copy; 2021 <a href=https://www.edwardesire.com/>Edward Desire</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p>
</div></div>
</footer>
</body>
</html>